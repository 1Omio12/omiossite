<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ORadiation Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #ffffff;
      color: #333;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      color: #0077cc;
    }

    h2 {
      font-size: 1.6em;
      color: #444;
      margin-bottom: 20px;
    }

    .controls {
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .controls label {
      font-size: 1.1em;
    }

    .controls input {
      padding: 10px;
      font-size: 1em;
      width: 100px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .controls button {
      padding: 10px 20px;
      font-size: 1em;
      background-color: #0077cc;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .controls button:hover {
      background-color: #005fa3;
    }

    #chart-container {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto 30px;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    #map {
      height: 600px;
      width: 100%;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .info {
      font-size: 0.9em;
      color: #666;
    }

    .legend {
      background: white;
      padding: 12px;
      border-radius: 5px;
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.2);
      line-height: 1.5;
      font-size: 0.9em;
      color: #333;
      width: 200px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .legend i {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .legend img {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      vertical-align: middle;
      flex-shrink: 0;
    }

    .legend button {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      font-size: 0.9em;
      background-color: #0077cc;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      transition: background-color 0.3s;
    }

    .legend button:hover {
      background-color: #005fa3;
    }

    #detector-container {
      margin: 100px auto;
      width: 300px;
      height: 600px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #detector-svg {
      width: 100%;
      height: 100%;
    }

    .detector-body {
      fill: #f7f9fb;
      stroke: #000;
      stroke-width: 2;
    }

    .detector-antenna {
      fill: #000;
      stroke: #000;
      stroke-width: 2;
    }

    .detector-screen {
      fill: #d6fded;
      stroke: #000;
      stroke-width: 1;
      filter: url(#glow);
    }

    .detector-button {
      fill: #0077cc;
      stroke: #000;
      stroke-width: 2;
    }

    .detector-text {
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
      fill: #000;
      text-anchor: middle;
      dominant-baseline: middle;
    }

    .detector-light {
      fill: red;
    }
  </style>
</head>
<body>
  <img src="Military_Institute_of_Science_and_Technology_Monogram.svg.png" alt="MIST Logo" style="position: absolute; top: 30px; left: 30px; height: 70px; z-index: 1000; border-radius: 8px;" />
  <h1>||OMIO'S RADIATION DATA||</h1>

  <div id="detector-container">
    <svg id="detector-svg" viewBox="0 0 150 300">
      <defs>
        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur in="SourceAlpha" stdDeviation="2" result="blur"/>
          <feFlood flood-color="#00ff00" flood-opacity="0.3"/>
          <feComposite in2="blur" operator="in"/>
          <feMerge>
            <feMergeNode/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      <rect x="65" y="10" width="20" height="20" class="detector-antenna"/>
      <line x1="75" y1="10" x2="75" y2="5" class="detector-antenna"/>
      <rect x="30" y="30" width="90" height="120" rx="10" class="detector-body"/>
      <text x="75" y="165" class="detector-text" style="font-size: 14px;">DETECTOR</text>
      <rect x="35" y="40" width="80" height="50" rx="5" class="detector-screen"/>
      <text x="75" y="65" class="detector-text" id="detector-display">N/A µSv/h</text>
      <image x="58" y="110" width="35" height="35" href="trifoil1.jpg" />
      <circle cx="75" cy="100" r="2" class="detector-light" id="detector-light"/>
    </svg>
  </div>

  <div class="controls">
    <label for="points">NUMBER OF DATA:</label>
    <input type="number" id="points" min="1" max="8000" value="8000" />
    <button onclick="updateMap()">UPDATE</button>
  </div>

  <div id="chart-container">
    <canvas id="radiationChart"></canvas>
  </div>

  <h2>Radiation Mapping</h2>
  <div id="map"></div>
  <p class="info">Map updates automatically every 5 seconds. Max 8000 points.</p>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>

  <script>
    const map = L.map('map').setView([23.685, 90.3563], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const markers = L.layerGroup().addTo(map);
    let latestValidFeed = null;
    let isInitialLoad = true; // Flag for initial load

    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'info legend');
      div.innerHTML = `
        <div class="legend-item">
          <i style="background:green"></i>
          <span>Less than 0.1 µSv/h</span>
        </div>
        <div class="legend-item">
          <i style="background:orange"></i>
          <span>0.1 to less than 0.5 µSv/h</span>
        </div>
        <div class="legend-item">
          <i style="background:red"></i>
          <span>0.5 µSv/h and above</span>
        </div>
        <div class="legend-item">
          <img src="https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png" />
          <span>Latest Location</span>
        </div>
        <button id="show-latest-location">Show Latest Location</button>
      `;
      L.DomEvent.on(div.querySelector('#show-latest-location'), 'click', function () {
        if (latestValidFeed) {
          const lat = parseFloat(latestValidFeed.field4);
          const lon = parseFloat(latestValidFeed.field5);
          const val = parseFloat(latestValidFeed.field3);
          const time = latestValidFeed.created_at;

          const customIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
          });

          L.marker([lat, lon], { icon: customIcon })
            .addTo(markers)
            .bindPopup(`Latest Location<br>Radiation: ${val} µSv/h<br>Time: ${time}`);

          map.panTo([lat, lon], { animate: true, duration: 1 });
        } else {
          alert('No valid latest location available.');
        }
      });
      return div;
    };
    legend.addTo(map);

    const ctx = document.getElementById('radiationChart').getContext('2d');
    const radiationChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Radiation Level (µSv/h)',
          data: [],
          borderColor: '#0077cc',
          backgroundColor: 'rgba(0, 119, 204, 0.2)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Radiation Level Over Time',
            font: { size: 20 },
            padding: { top: 10, bottom: 20 }
          }
        },
        scales: {
          x: {
            type: 'time',
            title: { display: true, text: 'Time' }
          },
          y: {
            title: { display: true, text: 'Radiation Level (µSv/h)' }
          }
        }
      }
    });

    function getColor(value) {
      if (value < 0.1) return 'green';
      if (value < 0.5) return 'orange';
      return 'red';
    }

    function fetchData(limit, resetView = false) {
      document.getElementById('detector-light').setAttribute('fill', 'red');

      const channelId = '2849195';
      const url = `https://api.thingspeak.com/channels/${channelId}/feeds.json?results=${limit}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          data.feeds.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
          markers.clearLayers();

          const times = [];
          const values = [];
          let sumLat = 0, sumLon = 0, count = 0;
          latestValidFeed = null;

          data.feeds.forEach(feed => {
            const lat = parseFloat(feed.field4);
            const lon = parseFloat(feed.field5);
            const val = parseFloat(feed.field3);
            const time = feed.created_at;

            if (!isNaN(lat) && !isNaN(lon) && lat >= 20.5 && lat <= 26.7 && lon >= 88 && lon <= 92.7) {
              if (!isNaN(val)) {
                times.push(time);
                values.push(val);
              }

              L.circleMarker([lat, lon], {
                radius: 6,
                fillColor: getColor(val),
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
              }).addTo(markers).bindPopup(`Radiation: ${val} µSv/h<br>Time: ${time}`);

              sumLat += lat;
              sumLon += lon;
              count++;

              if (!isNaN(val)) {
                latestValidFeed = feed;
              }
            }
          });

          const latest = data.feeds[data.feeds.length - 1];
          const latestVal = parseFloat(latest?.field3);
          document.getElementById('detector-display').textContent = isNaN(latestVal) ? 'N/A µSv/h' : `${latestVal.toFixed(2)} µSv/h`;

          radiationChart.data.labels = times;
          radiationChart.data.datasets[0].data = values;
          radiationChart.update();

          // Only reset the map view on initial load or when explicitly requested
          if ((isInitialLoad || resetView) && count > 0) {
            map.setView([sumLat / count, sumLon / count], 13);
            isInitialLoad = false; // Disable initial load flag after first run
          }
        })
        .catch(console.error)
        .finally(() => {
          document.getElementById('detector-light').setAttribute('fill', 'blue');
        });
    }

    function updateMap() {
      const val = parseInt(document.getElementById('points').value);
      if (val < 1 || val > 8000) {
        alert('Please enter a number between 1 and 8000.');
        return;
      }
      fetchData(val, true); // Pass resetView=true to reset view on manual update
    }

    fetchData(8000, true); // Initial load with view reset
    setInterval(() => fetchData(document.getElementById('points').value, false), 5000); // Periodic update without view reset
  </script>
</body>
</html>
