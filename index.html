<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ORadiation Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #1f2937;
      margin: 0;
      padding: 40px;
      min-height: 100vh;
    }

    h1 {
      font-size: 3rem;
      font-weight: 700;
      background: linear-gradient(to right, #3b82f6, #1d4ed8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
    }

    h2 {
      font-size: 1.875rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1.5rem;
    }

    .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .controls label {
      font-size: 1.125rem;
      font-weight: 500;
      color: #374151;
    }

    .controls input {
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      width: 120px;
      transition: border-color 0.3s ease;
    }

    .controls input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    #chart-container {
      background: #ffffff;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    #map {
      height: 600px;
      border-radius: 1rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .info {
      font-size: 0.875rem;
      color: #6b7280;
      text-align: center;
    }

    .legend {
      background: #ffffff;
      padding: 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      font-size: 0.875rem;
      color: #374151;
      width: 220px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .legend i {
      width: 16px;
      height: 16px;
      margin-right: 0.5rem;
      flex-shrink: 0;
    }

    .legend img {
      width: 16px;
      height: 16px;
      margin-right: 0.5rem;
      vertical-align: middle;
    }

    #detector-container {
      margin: 2rem auto;
      width: 300px;
      height: 600px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    #detector-svg {
      width: 100%;
      height: 100%;
    }

    .detector-body {
      fill: #e5e7eb;
      stroke: #374151;
      stroke-width: 2;
    }

    .detector-antenna {
      fill: #1f2937;
      stroke: #1f2937;
      stroke-width: 2;
    }

    .detector-screen {
      fill: #d1fae5;
      stroke: #374151;
      stroke-width: 1;
      filter: url(#glow);
    }

    .detector-button {
      fill: #3b82f6;
      stroke: #1f2937;
      stroke-width: 2;
    }

    .detector-text {
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
      fill: #1f2937;
      text-anchor: middle;
      dominant-baseline: middle;
    }

    .detector-light {
      fill: red;
      transition: fill 0.3s ease;
    }
  </style>
</head>
<body>
  <img src="Military_Institute_of_Science_and_Technology_Monogram.svg.png" alt="MIST Logo" class="absolute top-8 left-8 h-16 z-[1000] rounded-lg shadow-md" />
  <div class="container mx-auto">
    <h1 class="text-center">||OMIO'S RADIATION DATA||</h1>

    <div id="detector-container">
      <svg id="detector-svg" viewBox="0 0 150 300">
        <defs>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceAlpha" stdDeviation="2" result="blur"/>
            <feFlood flood-color="#10b981" flood-opacity="0.3"/>
            <feComposite in2="blur" operator="in"/>
            <feMerge>
              <feMergeNode/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        <rect x="65" y="10" width="20" height="20" class="detector-antenna"/>
        <line x1="75" y1="10" x2="75" y2="5" class="detector-antenna"/>
        <rect x="30" y="30" width="90" height="120" rx="10" class="detector-body"/>
        <text x="75" y="165" class="detector-text" style="font-size: 14px;">DETECTOR</text>
        <rect x="35" y="40" width="80" height="50" rx="5" class="detector-screen"/>
        <text x="75" y="65" class="detector-text" id="detector-display">N/A µSv/h</text>
        <image x="58" y="110" width="35" height="35" href="trifoil1.jpg" />
        <circle cx="75" cy="100" r="2" class="detector-light" id="detector-light"/>
      </svg>
    </div>

    <div class="controls">
      <label for="points" class="font-medium">NUMBER OF DATA:</label>
      <input type="number" id="points" min="1" max="8000" value="8000" class="focus:ring focus:ring-blue-200"/>
      <button onclick="updateMap()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out">UPDATE</button>
    </div>

    <div id="chart-container">
      <canvas id="radiationChart"></canvas>
    </div>

    <h2 class="text-center">Radiation Mapping</h2>
    <div id="map"></div>
    <p class="info">Map updates automatically every 5 seconds. Max 8000 points.</p>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
  <script>
    const map = L.map('map').setView([23.685, 90.3563], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const markers = L.layerGroup().addTo(map);
    let latestValidFeed = null;
    let isInitialLoad = true;

    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'info legend');
      div.innerHTML = `
        <div class="legend-item">
          <i style="background:#10b981"></i>
          <span>Less than 0.1 µSv/h</span>
        </div>
        <div class="legend-item">
          <i style="background:#f59e0b"></i>
          <span>0.1 to less than 0.5 µSv/h</span>
        </div>
        <div class="legend-item">
          <i style="background:#ef4444"></i>
          <span>0.5 µSv/h and above</span>
        </div>
        <div class="legend-item">
          <img src="https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png" />
          <span>Latest Location</span>
        </div>
        <button id="show-latest-location" class="bg-blue-600 text-white w-full py-2 mt-3 rounded-lg hover:bg-blue-700 transition duration-300">Show Latest Location</button>
      `;
      L.DomEvent.on(div.querySelector('#show-latest-location'), 'click', function () {
        if (latestValidFeed) {
          const lat = parseFloat(latestValidFeed.field4);
          const lon = parseFloat(latestValidFeed.field5);
          const val = parseFloat(latestValidFeed.field3);
          const time = latestValidFeed.created_at;

          const customIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
          });

          L.marker([lat, lon], { icon: customIcon })
            .addTo(markers)
            .bindPopup(`Latest Location<br>Radiation: ${val} µSv/h<br>Time: ${time}`);

          map.panTo([lat, lon], { animate: true, duration: 1 });
        } else {
          alert('No valid latest location available.');
        }
      });
      return div;
    };
    legend.addTo(map);

    const ctx = document.getElementById('radiationChart').getContext('2d');
    const radiationChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Radiation Level (µSv/h)',
          data: [],
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.2)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Radiation Level Over Time',
            font: { size: 20, family: 'Inter' },
            padding: { top: 10, bottom: 20 }
          }
        },
        scales: {
          x: {
            type: 'time',
            title: { display: true, text: 'Time', font: { family: 'Inter' } }
          },
          y: {
            title: { display: true, text: 'Radiation Level (µSv/h)', font: { family: 'Inter' } }
          }
        }
      }
    });

    function getColor(value) {
      if (value < 0.1) return '#10b981';
      if (value < 0.5) return '#f59e0b';
      return '#ef4444';
    }

    function fetchData(limit, resetView = false) {
      document.getElementById('detector-light').setAttribute('fill', '#ef4444');

      const channelId = '2849195';
      const url = `https://api.thingspeak.com/channels/${channelId}/feeds.json?results=${limit}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          data.feeds.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
          markers.clearLayers();

          const times = [];
          const values = [];
          let sumLat = 0, sumLon = 0, count = 0;
          latestValidFeed = null;

          data.feeds.forEach(feed => {
            const lat = parseFloat(feed.field4);
            const lon = parseFloat(feed.field5);
            const val = parseFloat(feed.field3);
            const time = feed.created_at;

            if (!isNaN(lat) && !isNaN(lon) && lat >= 20.5 && lat <= 26.7 && lon >= 88 && lon <= 92.7) {
              if (!isNaN(val)) {
                times.push(time);
                values.push(val);
              }

              L.circleMarker([lat, lon], {
                radius: 6,
                fillColor: getColor(val),
                color: '#1f2937',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
              }).addTo(markers).bindPopup(`Radiation: ${val} µSv/h<br>Time: ${time}`);

              sumLat += lat;
              sumLon += lon;
              count++;

              if (!isNaN(val)) {
                latestValidFeed = feed;
              }
            }
          });

          const latest = data.feeds[data.feeds.length - 1];
          const latestVal = parseFloat(latest?.field3);
          document.getElementById('detector-display').textContent = isNaN(latestVal) ? 'N/A µSv/h' : `${latestVal.toFixed(2)} µSv/h`;

          radiationChart.data.labels = times;
          radiationChart.data.datasets[0].data = values;
          radiationChart.update();

          if ((isInitialLoad || resetView) && count > 0) {
            map.setView([sumLat / count, sumLon / count], 13);
            isInitialLoad = false;
          }
        })
        .catch(console.error)
        .finally(() => {
          document.getElementById('detector-light').setAttribute('fill', '#3b82f6');
        });
    }

    function updateMap() {
      const val = parseInt(document.getElementById('points').value);
      if (val < 1 || val > 8000) {
        alert('Please enter a number between 1 and 8000.');
        return;
      }
      fetchData(val, true);
    }

    fetchData(8000, true);
    setInterval(() => fetchData(document.getElementById('points').value, false), 5000);
  </script>
</body>
</html>
